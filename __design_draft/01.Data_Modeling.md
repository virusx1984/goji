<!-- __design_draft/01.Data_Modeling.md -->
### **【最终审查版】Goji系统 - 最终数据库模型**

**版本:** 1.3
**日期:** 2025-08-24



### 1. Master Data (主數據)

#### 1.1. `customers` (客户主档)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `INTEGER` | 唯一主键 | Primary Key |
| **code** | `VARCHAR(50)` | 客户代码 | Not Null, Unique, Indexed |
| **name** | `VARCHAR(255)` | 客户法人/集团全称 | Not Null |
| **address** | `VARCHAR(500)` | 客户地址 |     |
| **contact_person** | `VARCHAR(100)` | 主要联系人 |     |
| **contact_phone** | `VARCHAR(50)` | 联系人电话 |     |
| **contact_email** | `VARCHAR(100)` | 联系人邮箱 |     |
| **is_active** | `BOOLEAN` | 客户是否启用 | Default: True |

#### 1.2. `customer_locations` (客户地点)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `INTEGER` | 唯一主键 | Primary Key |
| **cust_id** | `INTEGER` | 关联到客户 | 外键, 关联 `customers.id`, Not Null |
| **location_code** | `VARCHAR(50)` | 地点代码 | Not Null, Indexed |
| **location_name** | `VARCHAR(255)` | 地点名称 (如: HQ, Warehouse A) | Not Null |
| **address** | `VARCHAR(500)` | 地点详细地址 |     |
| **is_ship_to** | `BOOLEAN` | 是否为收货地址 | Default: False |
| **is_bill_to** | `BOOLEAN` | 是否为账单地址 | Default: False |

#### 1.3. `products` (产品主档)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `INTEGER` | 厂内唯一主键 | Primary Key |
| **product_status** | `VARCHAR(50)` | 产品状态 | Not Null, e.g., 'PLANNING', 'ACTIVE', 'EOL' |
| **ref_product_id** | `INTEGER` | 参考产品ID (用于规划) | 外键, 关联 `products.id`, 可为空 |
| **cust_id** | `INTEGER` | 关联到客户 | 外键, 关联 `customers.id`, Not Null |
| **cust_part_num** | `VARCHAR(100)` | 客户提供的料号 | Not Null, Indexed |
| **cust_ver** | `VARCHAR(50)` | 客户提供的版本号 | Not Null |
| **description** | `VARCHAR(500)` | 产品描述 |     |
| **pcs_per_strip** | `INTEGER` | (UOM) 每 strip 包含多少 pcs |     |
| **strips_per_panel** | `INTEGER` | (UOM) 每 panel 包含多少 strip |     |
| **end_cust_id** | `INTEGER` | 最终客户 | 外键, 关联 `customers.id`, 可为空 |

end_cust_id = db.Column(db.Integer, db.ForeignKey('gj_customers.id'), nullable=True)

#### 1.4. `materials` (物料主档)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `INTEGER` | 唯一主键 | Primary Key |
| **material_code** | `VARCHAR(100)` | 内部物料编码 | Not Null, Unique, Indexed |
| **description** | `VARCHAR(500)` | 物料描述 | Not Null |
| **uom** | `VARCHAR(20)` | 计量单位 | Not Null, e.g., 'PCS', 'KG', 'MTR' |
| **material_type** | `VARCHAR(50)` | 物料类型 | e.g., 'Raw Material', 'Component', 'FG' |
| **is_active** | `BOOLEAN` | 物料是否启用 | Default: True |

#### 1.5. `suppliers` (供应商主档)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `INTEGER` | 唯一主键 | Primary Key |
| **code** | `VARCHAR(50)` | 供应商代码 | Not Null, Unique, Indexed |
| **name** | `VARCHAR(255)` | 供应商名称 | Not Null |
| **address** | `VARCHAR(500)` | 供应商地址 |     |
| **contact_person** | `VARCHAR(100)` | 主要联系人 |     |
| **contact_phone** | `VARCHAR(50)` | 联系人电话 |     |
| **contact_email** | `VARCHAR(100)` | 联系人邮箱 |     |
| **is_active** | `BOOLEAN` | 供应商是否启用 | Default: True |

#### 1.6. `supplier_locations` (供应商地点)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `INTEGER` | 唯一主键 | Primary Key |
| **supplier_id** | `INTEGER` | 关联到供应商 | 外键, 关联 `suppliers.id`, Not Null |
| **location_code** | `VARCHAR(50)` | 地点代码 | Not Null, Indexed |
| **location_name** | `VARCHAR(255)` | 地点名称 (如: Factory A, Sales Office) | Not Null |
| **address** | `VARCHAR(500)` | 地点详细地址 |     |
| **is_manufacturing** | `BOOLEAN` | 是否为生产地点 | Default: False |
| **is_sales** | `BOOLEAN` | 是否为销售地点 | Default: False |

#### 1.7. `supplier_relationships` (供应商与物料关系)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `INTEGER` | 唯一主键 | Primary Key |
| **supplier_id** | `INTEGER` | 关联到供应商 | 外键, 关联 `suppliers.id`, Not Null |
| **mfg_id** | `INTEGER` | 关联到制造商 (如果供应商是分销商) | 外键, 关联 `suppliers.id`, 可为空 |
| **relation_type** | `VARCHAR(50)` | 关系类型 | e.g., 'Supplier', 'Distributor' |
| **supplier_part_num** | `VARCHAR(100)` | 供应商提供的料号 | Not Null |
| **is_preferred** | `BOOLEAN` | 是否为首选供应商 | Default: False |
| **lead_time_days** | `INTEGER` | 标准交期 (天) |     |
| **unit_price** | `DECIMAL(12,4)` | 标准单价 |     |
| **currency** | `VARCHAR(10)` | 货币单位 | e.g., 'USD', 'CNY' |
| **min_order_qty** | `INTEGER` | 最小订单量 |     |

#### 1.8. `material_suppliers` (物料与供应商关系)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `INTEGER` | 唯一主键 | Primary Key |
| **material_id** | `INTEGER` | 关联到物料 | 外键, 关联 `materials.id`, Not Null |
| **sup_loc_id** | `INTEGER` | 关联到供应商地点 | 外键, 关联 `supplier_locations.id`, Not Null |
| **supplier_part_num** | `VARCHAR(100)` | 供应商提供的料号 | Not Null |
| **is_preferred** | `BOOLEAN` | 是否为首选供应商 | Default: False |
| **lead_time_days** | `INTEGER` | 标准交期 (天) |     |
| **unit_price** | `DECIMAL(12,4)` | 标准单价 |     |
| **currency** | `VARCHAR(10)` | 货币单位 | e.g., 'USD', 'CNY' |
| **min_order_qty** | `INTEGER` | 最小订单量 |     |

#### 1.9. `work_centers` (工作中心)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `INTEGER` | 唯一主键 | Primary Key |
| **wc_code** | `VARCHAR(50)` | 工作中心代码 | Not Null, Unique, Indexed |
| **name** | `VARCHAR(255)` | 工作中心名称 | Not Null |
| **description** | `VARCHAR(500)` | 工作中心描述 |     |
| **plant_id** | `INTEGER` | 关联到工厂 | 外键, 关联 `plants.id`, Not Null |

#### 1.10. `work_center_assets` (工作中心与资产关联表)

- **说明:** 此表定义了工作中心可以使用的资产。
- **字段:**
  - `id` (`INTEGER`, Primary Key)
  - `wc_id` (`INTEGER`, 外键, 关联 `work_centers.id`, Not Null)
  - `asset_id` (`INTEGER`, 外键, 关联 `assets.id`, Not Null)

### 2. Demand Management (需求管理)

#### 2.1. `sales_orders` (销售订单)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `INTEGER` | 唯一主键 | Primary Key |
| **order_num** | `VARCHAR(50)` | 订单号 | Not Null, Unique, Indexed |
| **cust_id** | `INTEGER` | 关联到客户 | 外键, 关联 `customers.id`, Not Null |
| **ship_to_loc_id** | `INTEGER` | 收货地点 | 外键, 关联 `customer_locations.id`, Not Null |
| **order_date** | `DATE` | 订单日期 | Not Null |
| **order_status** | `VARCHAR(50)` | 订单状态 | Not Null, e.g., 'OPEN', 'CLOSED', 'CANCELLED' |

#### 2.2. `sales_order_lines` (销售订单行)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `INTEGER` | 唯一主键 | Primary Key |
| **order_id** | `INTEGER` | 关联到销售订单 | 外键, 关联 `sales_orders.id`, Not Null |
| **line_num** | `INTEGER` | 行号  | Not Null |
| **product_id** | `INTEGER` | 关联到产品 | 外键, 关联 `products.id`, Not Null |
| **quantity** | `INTEGER` | 订单数量 | Not Null |
| **unit_price** | `DECIMAL(12,4)` | 订单单价 | Not Null |
| **req_ship_date** | `DATE` | 要求发货日期 |     |
| **promised_ship_date** | `DATE` | 承诺发货日期 |     |
| **routing_id** | `INTEGER` | 关联到工艺路线 | 外键, 关联 `routings.id`, 可为空 |

#### 2.3. `forecast_sets` (预测集)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `INTEGER` | 唯一主键 | Primary Key |
| **cust_id** | `INTEGER` | 关联到客户 | 外键, 关联 `customers.id`, Not Null |
| **set_name** | `VARCHAR(100)` | 预测集名称 | Not Null |
| **submission_date** | `DATE` | 提交日期 | Not Null |
| **period_type** | `VARCHAR(50)` | 周期类型 | e.g., 'Weekly', 'Monthly' |
| **set_status** | `VARCHAR(50)` | 预测集状态 | Not Null, e.g., 'DRAFT', 'SUBMITTED', 'APPROVED' |

#### 2.4. `forecast_lines` (预测行)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `INTEGER` | 唯一主键 | Primary Key |
| **set_id** | `INTEGER` | 关联到预测集 | 外键, 关联 `forecast_sets.id`, Not Null |
| **product_id** | `INTEGER` | 关联到产品 | 外键, 关联 `products.id`, Not Null |
| **period_start_date** | `DATE` | 预测周期开始日期 | Not Null |
| **quantity** | `INTEGER` | 预测数量 | Not Null |

### 3. Process Management (生产过程管理)

#### 3.1. `routings` (工艺路线)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `INTEGER` | 唯一主键 | Primary Key |
| **product_id** | `INTEGER` | 关联到产品 | 外键, 关联 `products.id`, Not Null |
| **routing_code** | `VARCHAR(100)` | 工艺路线代码 | Not Null, Indexed |
| **version** | `VARCHAR(50)` | 工艺路线版本 | Not Null |
| **is_active** | `BOOLEAN` | 工艺路线是否启用 | Default: True |

#### 3.2. `routing_operations` (工艺路线工序)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `INTEGER` | 唯一主键 | Primary Key |
| **routing_id** | `INTEGER` | 关联到工艺路线 | 外键, 关联 `routings.id`, Not Null |
| **operation_sequence** | `INTEGER` | 工序顺序 | Not Null |
| **operation_name** | `VARCHAR(255)` | 工序名称 | Not Null |
| **work_center_id** | `INTEGER` | 关联到工作中心 | 外键, 关联 `work_centers.id`, Not Null |

#### 3.3. `bom_items` (物料清单项目)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `INTEGER` | 唯一主键 | Primary Key |
| **routing_op_id** | `INTEGER` | 关联到工艺路线工序 | 外键, 关联 `routing_operations.id`, Not Null |
| **material_id** | `INTEGER` | 关联到物料 | 外键, 关联 `materials.id`, Not Null |
| **quantity** | `DECIMAL(12,4)` | 数量  | Not Null |
| **uom** | `VARCHAR(20)` | 计量单位 | Not Null |
| **base_qty** | `DECIMAL(12,4)` | 基础数量 | Not Null |
| **base_uom** | `VARCHAR(20)` | 基础计量单位 | Not Null |
| **multiplier** | `DECIMAL(12,4)` | 乘数  |     |
| **scrap_pct** | `DECIMAL(5,2)` | 报废百分比 | Default: 0.00 |
| **notes** | `TEXT` | 备注  |     |

#### 3.4. `alternate_materials` (替代物料)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `INTEGER` | 唯一主键 | Primary Key |
| **bom_item_id** | `INTEGER` | 关联到BOM项目 | 外键, 关联 `bom_items.id`, Not Null |
| **alt_material_id** | `INTEGER` | 关联到替代物料 | 外键, 关联 `materials.id`, Not Null |
| **priority** | `INTEGER` | 优先级 | Not Null, 1为最高优先级 |

#### 3.5. `operation_resources` (工序资源与时间标准)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `INTEGER` | 唯一主键 | Primary Key |
| **routing_op_id** | `INTEGER` | 关联到工艺路线工序 | 外键, 关联 `routing_operations.id`, Not Null |
| **wc_id** | `INTEGER` | 关联到工作中心 | 外键, 关联 `work_centers.id`, Not Null |
| **setup_time_sec** | `INTEGER` | 设置时间 (秒) |     |
| **raw_run_time_val** | `DECIMAL(10,4)` | 原始运行时间值 |     |
| **raw_run_time_uom** | `VARCHAR(20)` | 原始运行时间单位 | e.g., 'MIN', 'HOUR' |
| **items_per_raw_uom** | `DECIMAL(10,4)` | 每原始单位的物料数量 |     |
| **run_time_sec_per_pc** | `DECIMAL(10,4)` | 每PCS的运行时间 (秒) |     |
| **pref_level** | `INTEGER` | 首选级别 |     |
| **is_active** | `BOOLEAN` | 该资源配置是否启用 | Default: True |

### 4. System Management (系统管理)

#### 4.1. `users` (用户表)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `INTEGER` | 唯一主键 | Primary Key |
| **username** | `VARCHAR(100)` | 用户名 | Not Null, Unique, Indexed |
| **password_hash** | `VARCHAR(255)` | 加密后的密码 | Not Null |
| **full_name** | `VARCHAR(255)` | 用户全名 | Not Null |
| **email** | `VARCHAR(100)` | 用户邮箱 | Not Null, Unique |
| **is_active** | `BOOLEAN` | 用户是否启用 | Default: True |

#### 4.2. `roles` (角色表)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `INTEGER` | 唯一主键 | Primary Key |
| **name** | `VARCHAR(100)` | 角色名称 | Not Null, Unique, Indexed |
| **description** | `VARCHAR(500)` | 角色描述 |     |

#### 4.3. `permissions` (权限表)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `INTEGER` | 唯一主键 | Primary Key |
| **name** | `VARCHAR(100)` | 权限名称 (如: 'view_products', 'edit_orders') | Not Null, Unique, Indexed |
| **description** | `VARCHAR(500)` | 权限描述 |     |

#### 4.4. `menus` (菜单表)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `INTEGER` | 唯一主键 | Primary Key |
| **parent_id** | `INTEGER` | 父菜单ID | 外键, 关联 `menus.id`, 可为空 |
| **name** | `VARCHAR(100)` | 菜单名称 | Not Null |
| **route** | `VARCHAR(255)` | 菜单路由路径 |     |
| **icon** | `VARCHAR(100)` | 菜单图标 |     |
| **order_num** | `INTEGER` | 菜单排序号 |     |
| **required_permission_id** | `INTEGER` | 访问该菜单所需的权限 | 外键, 关联 `permissions.id`, 可为空 |

#### 4.5. `user_roles` (用户与角色关联表)

- **说明:** 此表用于将用户与角色关联，并可以定义作用域。
- **字段:**
  - `id` (`INTEGER`, Primary Key)
  - `user_id` (`INTEGER`, 外键, 关联 `users.id`, Not Null)
  - `role_id` (`INTEGER`, 外键, 关联 `roles.id`, Not Null)
  - `plant_id` (`INTEGER`, 外键, 关联 `plants.id`, 可为空)
  - `bu_id` (`INTEGER`, 外键, 关联 `business_units.id`, 可为空)
- **唯一约束:** `uq_user_role_scope` on (`user_id`, `role_id`, `plant_id`, `bu_id`)

#### 4.6. `role_permissions` (角色与权限关联表)

- **说明:** 此表用于将角色与权限关联。
- **字段:**
  - `id` (`INTEGER`, Primary Key)
  - `role_id` (`INTEGER`, 外键, 关联 `roles.id`, Not Null)
  - `permission_id` (`INTEGER`, 外键, 关联 `permissions.id`, Not Null)
- **唯一约束:** `uq_role_permission` on (`role_id`, `permission_id`)

#### 4.7. `audit_logs` (审计日志)

| 字段名 | 数据类型 | 说明  | 备注  |
| --- | --- | --- | --- |
| **id** | `BIGINT` | 唯一主键 | Primary Key |
| **user_id** | `INTEGER` | 操作用户ID | 外键, 关联 `users.id`, 可为空 |
| **action_type** | `VARCHAR(50)` | 操作类型 | e.g., 'CREATE', 'UPDATE', 'DELETE' |
| **table_name** | `VARCHAR(100)` | 操作的表名 |     |
| **record_id** | `VARCHAR(100)` | 操作记录的ID |     |
| **before_value** | `TEXT` | 操作前的值 (JSON格式) | 可为空 |
| **after_value** | `TEXT` | 操作后的值 (JSON格式) | 可为空 |
| **ip_address** | `VARCHAR(50)` | 操作IP地址 |     |
| **timestamp** | `TIMESTAMP` | 操作时间 | Not Null |

---

